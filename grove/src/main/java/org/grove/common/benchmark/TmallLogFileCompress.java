package org.grove.common.benchmark;

import java.io.ByteArrayOutputStream;
import java.nio.ByteBuffer;

import org.apache.commons.compress.compressors.bzip2.BZip2CompressorOutputStream;
import org.apache.commons.compress.compressors.gzip.GzipCompressorOutputStream;
import org.junit.Before;
import org.junit.Test;

public class TmallLogFileCompress {

	String p1 = "9656205633|10213677963|9902850541|10483554667|14241223264|14297971886|22036916808|9900714059|17461691145|9773084909|10104197659|20386916518|16577155177|15678545617|19661032617|9772265963|9586488669|20574324847|9936554675|17705079591|10702238365|16878451321|15139759085|19448600474|13358341088|10853484593|16755796729|15781518849|9899709477|21183088256|9614380561|17487755784|20035924136|20523952190|20524480236|10350884955|10387322019|10552405423|12466744423|17610559999|9848421115|10352573567|15627725020|15625450646|15603981995|9592973009|24889648280|13995849156|24890760925|24891964848|18348009793|18333298609|9594820609|24894552919|24895304697|16871607156|19286500594|15761754484|15761802972|9784288313";
	String p2 = "5.80|31.60|5.60|16.20|11.50|12.00|8.00|28.80|68.00|6.00|12.00|49.00|4.00|30.00|112.80|45.02|228.00|49.00|68.00|27.20|71.10|30.00|18.00|68.00|12.58|35.10|32.00|110.60|28.80|14.00|22.00|88.00|59.00|96.00|94.40|59.00|20.00|89.00|89.00|88.00|168.00|158.00|50.00|30.00|61.20|59.00|68.00|298.00|50.00|158.00|49.00|39.50|53.10|35.00|49.00|45.00|50.00|228.00|168.00|39.00";
	String s = "1341020|1006670|1013560|894461|892515|901874|881364|862192|532550|822147|832448|766018|866689|776722|804227|454207|454207|766018|470479|773483|251092|251092|851869|251092|521307|493809|497239|251092|521307|774597|470479|454207|470479|454207|251092|454207|251092|251092|454207|251092|251092|251092|251092|251092|251092|251092|230169|251092|230169|230169|230169|230169|251092|230169|230169|251092|251092|251092|251092|454207";
	//706, 363,422,1826
	//1491 占比 0.816538882803943
	//String sss = "l	125	813e284042c5e44b537928cd2f9ced19	0	0	125.211.68.82	null	null	316452926	2	stype:list	null	-1	-1	-1	-1grid	0	null	1	null	http://jzy.tmall.com/i/m.htm?mid=w-2548722107-0	http://detail.tmall.com/item.htm?spm=a230r.1.14.327.rExggu&id=10825176191	20130708121843	list	5.80|31.60|5.60|16.20|11.50|12.00|8.00|28.80|68.00|6.00|12.00|49.00|4.00|30.00|112.80|45.02|228.00|49.00|68.00|27.20|71.10|30.00|18.00|68.00|12.58|35.10|32.00|110.60|28.80|14.00|22.00|88.00|59.00|96.00|94.40|59.00|20.00|89.00|89.00|88.00|168.00|158.00|50.00|30.00|61.20|59.00|68.00|298.00|50.00|158.00|49.00|39.50|53.10|35.00|49.00|45.00|50.00|228.00|168.00|39.00	null	1341020|1006670|1013560|894461|892515|901874|881364|862192|532550|822147|832448|766018|866689|776722|804227|454207|454207|766018|470479|773483|251092|251092|851869|251092|521307|493809|497239|251092|521307|774597|470479|454207|470479|454207|251092|454207|251092|251092|454207|251092|251092|251092|251092|251092|251092|251092|230169|251092|230169|230169|230169|230169|251092|230169|230169|251092|251092|251092|251092|454207	null	null	null	9656205633|10213677963|9902850541|10483554667|14241223264|14297971886|22036916808|9900714059|17461691145|9773084909|10104197659|20386916518|16577155177|15678545617|19661032617|9772265963|9586488669|20574324847|9936554675|17705079591|10702238365|16878451321|15139759085|19448600474|13358341088|10853484593|16755796729|15781518849|9899709477|21183088256|9614380561|17487755784|20035924136|20523952190|20524480236|10350884955|10387322019|10552405423|12466744423|17610559999|9848421115|10352573567|15627725020|15625450646|15603981995|9592973009|24889648280|13995849156|24890760925|24891964848|18348009793|18333298609|9594820609|24894552919|24895304697|16871607156|19286500594|15761754484|15761802972|9784288313	null	shopid:676697802	NULL	NULL	NULL	20130708";
	String log = "l	125	813e284042c5e44b537928cd2f9ced19	0	0	125.211.68.82	null	null	316452926	2	stype:list	null	-1	-1	-1	-1grid	0	null	1	null	http://jzy.tmall.com/i/m.htm?mid=w-2548722107-0	http://detail.tmall.com/item.htm?spm=a230r.1.14.327.rExggu&id=10825176191	20130708121843	list		null		null	null	null		null	shopid:676697802	NULL	NULL	NULL	20130708";
	long[] productArray = new long[] { 9656205633L, 10213677963L, 9902850541L, 10483554667L, 14241223264L, 14297971886L, 22036916808L,
			9900714059L, 17461691145L, 9773084909L, 10104197659L, 20386916518L, 16577155177L, 15678545617L, 19661032617L, 9772265963L,
			9586488669L, 20574324847L, 9936554675L, 17705079591L, 10702238365L, 16878451321L, 15139759085L, 19448600474L, 13358341088L,
			10853484593L, 16755796729L, 15781518849L, 9899709477L, 21183088256L, 9614380561L, 17487755784L, 20035924136L, 20523952190L,
			20524480236L, 10350884955L, 10387322019L, 10552405423L, 12466744423L, 17610559999L, 9848421115L, 10352573567L,
			15627725020L, 15625450646L, 15603981995L, 9592973009L, 24889648280L, 13995849156L, 24890760925L, 24891964848L,
			18348009793L, 18333298609L, 9594820609L, 24894552919L, 24895304697L, 16871607156L, 19286500594L, 15761754484L,
			15761802972L, 9784288313L };
	double[] priceArray = new double[] { 5.80, 31.60, 5.60, 16.20, 11.50, 12.00, 8.00, 28.80, 68.00, 6.00, 12.00, 49.00, 4.00, 30.00,
			112.80, 45.02, 228.00, 49.00, 68.00, 27.20, 71.10, 30.00, 18.00, 68.00, 12.58, 35.10, 32.00, 110.60, 28.80, 14.00, 22.00,
			88.00, 59.00, 96.00, 94.40, 59.00, 20.00, 89.00, 89.00, 88.00, 168.00, 158.00, 50.00, 30.00, 61.20, 59.00, 68.00, 298.00,
			50.00, 158.00, 49.00, 39.50, 53.10, 35.00, 49.00, 45.00, 50.00, 228.00, 168.00, 39.00 };
	int[] score = new int[] { 1341020, 1006670, 1013560, 894461, 892515, 901874, 881364, 862192, 532550, 822147, 832448, 766018,
			866689, 776722, 804227, 454207, 454207, 766018, 470479, 773483, 251092, 251092, 851869, 251092, 521307, 493809, 497239,
			251092, 521307, 774597, 470479, 454207, 470479, 454207, 251092, 454207, 251092, 251092, 454207, 251092, 251092, 251092,
			251092, 251092, 251092, 251092, 230169, 251092, 230169, 230169, 230169, 230169, 251092, 230169, 230169, 251092, 251092,
			251092, 251092, 454207 };
	
	
	@Before
	public void init(){
		System.out.println(p1.getBytes().length + p2.getBytes().length + s.getBytes().length + "," + log.getBytes().length);
	}
	
	
	@Test
	public void compressString() throws Exception {
		varint(productArray, priceArray, score);
		
		int total = p1.getBytes().length + p2.getBytes().length + s.getBytes().length;
		byte[] data = new byte[total];
		ByteBuffer buf = ByteBuffer.allocate(total);
		buf.put(p1.getBytes());
		buf.put(p2.getBytes());
		buf.put(s.getBytes());
		buf.flip();
		buf.get(data);
		
		//
		bzip2(data);
		//
		gzip(data);
		
		System.out.println((int)(9656205633L/1024));
		System.out.println((int)9656205633L);
		
	}
	
	

	public void bzip2(byte[] data) throws Exception {
		ByteArrayOutputStream byteArrayos = new ByteArrayOutputStream();
		BZip2CompressorOutputStream bzip2 = new BZip2CompressorOutputStream(byteArrayos);
		bzip2.write(data);
		bzip2.close();
		System.out.println("bzip2 compressed size : " + byteArrayos.toByteArray().length);
		byteArrayos.close();
	}

	public void gzip(byte[] data) throws Exception {
		ByteArrayOutputStream byteArrayos2 = new ByteArrayOutputStream();
		GzipCompressorOutputStream gzip = new GzipCompressorOutputStream(byteArrayos2);
		gzip.write(data);
		gzip.close();
		System.out.println("gzip compressed size : " + byteArrayos2.toByteArray().length);
		byteArrayos2.close();
	}

	public void varint(long[] productArray, double[] priceArray, int[] score) throws Exception {
		LogOutput dout = new LogOutput();
		for (int i = 0; i < priceArray.length; i++) {
			dout.writeVInt((int) (priceArray[i] * 100));
		}
		for (int i = 0; i < productArray.length; i++) {
			dout.writeVLong(productArray[i]);
		}
		for (int i = 0; i < score.length; i++) {
			dout.writeVInt(score[i]);
		}
		byte[] data = dout.getData();
		System.out.println("Vint Compressed size : " + data.length);

		LogInput logInput = new LogInput(data);
		for (int i = 0; i < 60; i++) {
			System.out.print(logInput.readVInt()+" ");
		}
		System.out.println();
	}

}
